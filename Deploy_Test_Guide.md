# Deploy Test - G1正弦波测试工具

## 🌊 概述

`deploy_test` 是一个专门用于测试G1机器人DDS到CAN桥接器的正弦波运动工具。它以**50Hz频率**发送正弦曲线运动命令到motor_controller，用于验证500Hz插值功能。

## 🎯 核心特性

### **正弦波运动生成**
- 📐 **精确数学模型**: `position = amplitude × sin(2π × frequency × time + phase)`
- 🎛️ **多关节控制**: 同时控制4个踝关节，支持不同相位偏移
- ⚡ **精确频率控制**: 默认50Hz，可调节20Hz-100Hz
- 📊 **实时监控**: 显示命令频率、正弦值和系统状态

### **运动参数**
- **默认幅度**: 0.3 rad (≈17°)
- **默认频率**: 0.5 Hz (2秒周期)
- **默认发布频率**: 50 Hz
- **测试持续时间**: 30秒

### **目标关节配置**
| 关节 | G1 ID | 名称 | 相位偏移 | 作用 |
|------|-------|------|----------|------|
| 左踝俯仰 | 4 | LeftAnklePitch | 0° | 基准正弦波 |
| 左踝滚转 | 5 | LeftAnkleRoll | 0° | 基准正弦波 |
| 右踝俯仰 | 10 | RightAnklePitch | 180° | 反向正弦波 |
| 右踝滚转 | 11 | RightAnkleRoll | 0° | 基准正弦波 |

## 🚀 使用方法

### **基本用法**
```bash
./build/bin/deploy_test veth0
```

### **高级参数配置**
```bash
# 更大幅度 (0.5 rad ≈ 28.6°)
./build/bin/deploy_test veth0 --amplitude 0.5

# 更快频率 (1.0 Hz, 1秒周期)
./build/bin/deploy_test veth0 --frequency 1.0

# 更慢频率 (20Hz发布, 60秒测试)
./build/bin/deploy_test veth0 --rate 20 --duration 60

# 组合参数
./build/bin/deploy_test veth0 --amplitude 0.2 --frequency 0.3 --rate 100 --duration 45
```

### **完整测试流程**
```bash
# 终端1: 启动motor_controller (500Hz接收和插值)
./build/bin/motor_controller veth0 can0

# 终端2: 启动deploy_test (50Hz发送正弦波)
./build/bin/deploy_test veth0

# 终端3: 监控CAN通信 (验证500Hz输出)
./build/bin/can_quick_test.sh
```

## 📊 输出示例

### **启动信息**
```
🌊 正弦波测试工具初始化完成
📊 测试参数:
   - 幅度: 0.3 rad (17.2°)
   - 频率: 0.5 Hz
   - 发布频率: 50.0 Hz
   - 持续时间: 30.0 秒

🌊 [0.50s] CMD #  25 | 正弦值: +0.142 rad ( +8.1°) | 频率: 50.0 Hz
```

### **实时监控**
```
📈 实时统计 [2.0s] - 命令: 50Hz, 状态: 500Hz
📈 实时统计 [4.0s] - 命令: 50Hz, 状态: 500Hz
```

### **最终统计**
```
📊 测试完成统计
======================================
测试时长: 30.0 秒
总命令数: 1500
总状态数: 15000
平均命令频率: 50.0 Hz
平均状态频率: 500.0 Hz
======================================

🌊 正弦波参数验证:
   预期周期数: 15.0
   实际周期数: 15.0
```

## 🔬 验证500Hz插值功能

### **测试场景对比**
| 场景 | DDS发送频率 | CAN输出频率 | 插值效果 |
|------|-------------|-------------|----------|
| **deploy_test** | 50Hz | 500Hz | **10倍插值** |
| g1_ankle_swing | ~100Hz | 500Hz | **5倍插值** |
| 理想状态 | 500Hz | 500Hz | **无需插值** |

### **验证指标**
1. **插值比例**: `500Hz ÷ 50Hz = 10倍插值`
2. **平滑度**: 10个CAN点之间应该形成平滑曲线
3. **延迟**: DDS命令到CAN输出延迟 <5ms
4. **频率稳定性**: CAN输出误差 <1%

### **验证方法**
```bash
# 运行deploy_test (50Hz输入)
./build/bin/deploy_test veth0 --duration 10 &

# 验证CAN输出频率 (应该接近500Hz)
./build/bin/can_quick_test.sh

# 验证插值效果
python3 verify_500hz.py
```

## 🎛️ 参数详解

### **--amplitude <rad>**
- **范围**: 0.01 ~ 1.57 rad (0.6° ~ 90°)
- **默认**: 0.3 rad (17.2°)
- **影响**: 控制运动幅度，避免电机限位

### **--frequency <hz>**
- **范围**: 0.1 ~ 5.0 Hz
- **默认**: 0.5 Hz (2秒周期)
- **影响**: 控制运动速度，频率过高可能不稳定

### **--rate <hz>**
- **范围**: 10 ~ 200 Hz
- **默认**: 50 Hz
- **影响**: DDS命令发布频率，影响插值比例

### **--duration <s>**
- **范围**: 1 ~ 600 秒
- **默认**: 30 秒
- **影响**: 测试持续时间，建议≥20秒以看到完整周期

## 📈 正弦波数学模型

### **位置方程**
```
position(t) = A × sin(2π × f × t + φ)

其中:
- A = amplitude (幅度)
- f = frequency (频率)
- t = time (时间)
- φ = phase_offset (相位偏移)
```

### **速度方程**
```
velocity(t) = A × 2π × f × cos(2π × f × t + φ)
```

### **运动范围**
```
位置: [-A, +A]
速度: [-A × 2π × f, +A × 2π × f]
```

## 🔍 故障排除

### **问题1: DDS连接失败**
**症状**: `🔗 初始化DDS网络接口失败`
**解决**:
```bash
# 检查网络接口
ip link show veth0

# 启用接口
sudo ip link set veth0 up

# 添加IP地址
sudo ip addr add 192.168.99.1/24 dev veth0
```

### **问题2: CAN输出频率不对**
**症状**: CAN频率不是500Hz
**解决**:
- 确认motor_controller正在运行
- 检查CAN接口状态: `ip link show can0`
- 使用验证工具检查插值功能

### **问题3: 正弦波不平滑**
**症状**: CAN输出有抖动
**解决**:
- 降低发布频率到20Hz
- 检查系统负载
- 确认motor_controller的插值算法

### **问题4: 电机不动**
**症状**: CAN命令发送但电机无响应
**解决**:
- 检查CAN ID映射 (0x201-0x204)
- 确认STM32控制板连接
- 检查电机电源和配置

## 📊 性能基准

### **正常运行指标**
| 指标 | 期望值 | 可接受范围 |
|------|--------|------------|
| DDS发送频率 | 50Hz | 45-55Hz |
| CAN输出频率 | 500Hz | 495-505Hz |
| 命令延迟 | <2ms | <5ms |
| CPU使用率 | <10% | <20% |
| 内存占用 | <100MB | <200MB |

### **测试结果示例**
```
测试时间: 60秒
DDS命令: 3000条 (50.0Hz)
CAN帧: 30000条 (500.0Hz)
插值比例: 10.0倍
成功率: 99.8%
```

## 🎮 实际应用场景

### **1. 插值功能验证**
```bash
# 测试10倍插比
./build/bin/deploy_test veth0 --duration 20
# 预期: 20s × 50Hz = 1000条DDS命令
# 预期: 20s × 500Hz = 10000条CAN帧
```

### **2. 系统压力测试**
```bash
# 高频测试
./build/bin/deploy_test veth0 --rate 100 --duration 60
# 测试motor_controller在高频输入下的表现
```

### **3. 运动范围测试**
```bash
# 大幅度测试
./build/bin/deploy_test veth0 --amplitude 0.6 --duration 30
# 测试电机的大角度运动能力
```

## 🔮 扩展建议

### **已实现功能**
- ✅ 50Hz DDS发布
- ✅ 正弦波运动生成
- ✅ 多关节协调控制
- ✅ 实时频率监控
- ✅ 参数可配置

### **可扩展功能**
- 🔄 **更多波形类型**: 方波、三角波、随机信号
- 📊 **轨迹记录**: 保存运动数据用于分析
- 🎛️ **PID参数调节**: 实时调节增益参数
- 📱 **Web界面**: 远程监控和控制
- 🤖 **更多关节**: 支持全身关节运动

---

**注意**: 使用deploy_test前请确保motor_controller已启动并可正常接收DDS消息。